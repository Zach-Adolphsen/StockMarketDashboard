name: Supabase to Power BI Sync

on:
  schedule:
    # Run every day at 4:30 PM EST (9:30 PM UTC)
    - cron: '30 21 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  DB_HOST: ${{ secrets.SUPABASE_DB_HOST }}
  DB_PORT: ${{ secrets.SUPABASE_DB_PORT }}
  DB_USER: ${{ secrets.SUPABASE_DB_USER }}
  DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}
  DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
  EXPORT_TABLE: analytics_symbol_daily_snapshot
  EXPORT_FILE: ${{ github.workspace }}/analytics_symbol_daily_snapshot.csv

jobs:
  sync-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install PostgreSQL client
        run: sudo apt-get install -y postgresql-client

      - name: Run stock data pipeline
        env:
          API_KEY: ${{ secrets.API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          python -m src.main

      - name: Export data to CSV
        env:
          SUPABASE_PASSWORD: ${{ env.SUPABASE_DB_PASSWORD }}
        run: |
              psql \
                -h "$DB_HOST" \
                -p "$DB_PORT" \
                -U "$DB_USER" \
                -d "$DB_NAME" \
                -c "\copy $EXPORT_TABLE TO '$EXPORT_FILE' CSV HEADER" 2>&1 | grep -v "password" || true
              
              if [ ! -f "$EXPORT_FILE" ] || [ ! -s "$EXPORT_FILE" ]; then
                echo "Error: CSV export failed or file is empty"
                exit 1
              fi
              
              echo "Successfully exported $EXPORT_TABLE to CSV"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: 'Supabase to Power BI sync failed. Check the workflow logs for details.'
                })

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: workflow-logs
          path: logs/
          retention-days: 7
